import{a as l}from"./chunk-BDTDWLGO.mjs";import{a as o,b as c}from"./chunk-U6Z4FNB7.mjs";import{a as h,h as d}from"./chunk-7IY2Y73Q.mjs";import{f as u}from"./chunk-X7QBDRQR.mjs";var p="fulfilled",f=class{constructor(t,n,e=30,s=100,r=10){this.taskQueue=new o;this.transactionsQueue=new o;this.outstandingTransactions=new o;this.sentTransactions=[];this.executedTransactions=[];this.aptosConfig=t,this.account=n,this.started=!1,this.accountSequnceNumber=new l(t,n,e,s,r)}async submitNextTransaction(){try{for(;;){if(this.transactionsQueue.isEmpty())return;let t=await this.accountSequnceNumber.nextSequenceNumber();if(t===null)return;let n=await this.generateNextTransaction(this.account,t);if(!n)return;let e=d({aptosConfig:this.aptosConfig,transaction:n,signer:this.account});await this.outstandingTransactions.enqueue([e,t])}}catch(t){if(t instanceof c)return;throw new Error(`Submit transaction failed for ${this.account.accountAddress.toString()} with error ${t}`)}}async processTransactions(){try{for(;;){let t=[],n=[],[e,s]=await this.outstandingTransactions.dequeue();for(t.push(e),n.push(s);!this.outstandingTransactions.isEmpty();)[e,s]=await this.outstandingTransactions.dequeue(),t.push(e),n.push(s);let r=await Promise.allSettled(t);for(let a=0;a<r.length&&a<n.length;a+=1){let i=r[a];s=n[a],i.status===p?(this.sentTransactions.push([i.value.hash,s,null]),await this.checkTransaction(i,s)):this.sentTransactions.push([i.status,s,i.reason])}}}catch(t){if(t instanceof c)return;throw new Error(`Process execution failed for ${this.account.accountAddress.toString()} with error ${t}`)}}async checkTransaction(t,n){try{let e=[];e.push(u({aptosConfig:this.aptosConfig,transactionHash:t.value.hash}));let s=await Promise.allSettled(e);for(let r=0;r<s.length;r+=1){let a=s[r];a.status===p?this.executedTransactions.push([a.value.hash,n,null]):this.executedTransactions.push([a.status,n,a.reason])}}catch(e){throw new Error(`Check transaction failed for ${this.account.accountAddress.toString()} with error ${e}`)}}async push(t,n){await this.transactionsQueue.enqueue([t,n])}async generateNextTransaction(t,n){if(this.transactionsQueue.isEmpty())return;let[e,s]=await this.transactionsQueue.dequeue();return await h({aptosConfig:this.aptosConfig,sender:t.accountAddress,data:e,options:{...s,accountSequenceNumber:n}})}async run(){try{for(;!this.taskQueue.isCancelled();)await(await this.taskQueue.dequeue())()}catch(t){throw new Error(`Unable to start transaction batching: ${t}`)}}start(){if(this.started)throw new Error("worker has already started");this.started=!0,this.taskQueue.enqueue(()=>this.submitNextTransaction()),this.taskQueue.enqueue(()=>this.processTransactions()),this.run()}stop(){if(this.taskQueue.isCancelled())throw new Error("worker has already stopped");this.started=!1,this.taskQueue.cancel()}};export{f as a};
//# sourceMappingURL=chunk-DYJVDOBH.mjs.map